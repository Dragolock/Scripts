-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- PLAYER REFERENCES
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- SETTINGS
local MAX_DISTANCE = 1000
local LOCK_SMOOTHNESS = 0.001
local FIRE_COOLDOWN = 0.5

-- How precise the camera must be (degrees)
local LOCK_ANGLE_THRESHOLD = 2 -- smaller = stricter

-- UI BUTTON PATH
local FireButton = PlayerGui
	:WaitForChild("MobileControls")
	:WaitForChild("Frame")
	:WaitForChild("FireButton")

-- STATE
local lastFireTime = 0

-- VISIBILITY CHECK
local function isVisible(targetPart)
	if not LocalPlayer.Character then return false end

	local origin = Camera.CFrame.Position
	local direction = targetPart.Position - origin

	local params = RaycastParams.new()
	params.FilterType = Enum.RaycastFilterType.Blacklist
	params.FilterDescendantsInstances = {LocalPlayer.Character}
	params.IgnoreWater = true

	local result = Workspace:Raycast(origin, direction, params)
	return result and result.Instance:IsDescendantOf(targetPart.Parent)
end

-- GET NEAREST VISIBLE PLAYER
local function getNearestVisibleCharacter()
	local closest
	local shortest = MAX_DISTANCE

	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character then
			local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
			local head = player.Character:FindFirstChild("Head")

			if humanoid and humanoid.Health > 0 and head and isVisible(head) then
				local distance = (Camera.CFrame.Position - head.Position).Magnitude
				if distance < shortest then
					shortest = distance
					closest = player.Character
				end
			end
		end
	end

	return closest
end

-- CHECK IF CAMERA IS FULLY LOCKED
local function isCameraLockedOn(head)
	local camLook = Camera.CFrame.LookVector.Unit
	local targetDir = (head.Position - Camera.CFrame.Position).Unit

	local dot = camLook:Dot(targetDir)
	local angle = math.deg(math.acos(math.clamp(dot, -1, 1)))

	return angle <= LOCK_ANGLE_THRESHOLD
end

-- MAIN LOOP
RunService.RenderStepped:Connect(function()
	local target = getNearestVisibleCharacter()
	if not target then return end

	local head = target:FindFirstChild("Head")
	if not head then return end

	-- Smooth camera lock
	local targetCFrame = CFrame.new(Camera.CFrame.Position, head.Position)
	Camera.CFrame = Camera.CFrame:Lerp(targetCFrame, LOCK_SMOOTHNESS)

	-- Fire ONLY when fully locked
	if isCameraLockedOn(head) and tick() - lastFireTime >= FIRE_COOLDOWN then
		if FireButton and FireButton.Activate then
			FireButton:Activate()
			lastFireTime = tick()
		end
	end
end)
